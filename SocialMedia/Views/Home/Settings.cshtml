@{
    ViewData["Title"] = "Settings";
}
@using Service.ViewModels
@model OTPViewModel
@{
    ViewData["Title"] = "Settings";
}

<style>
    .custom-btn {
        width: 200px;
    }

    .container {
        max-width: 1400px;
    }

    h2 {
        color: #007bff;
    }

    p {
        color: #555;
    }

    .modal-content {
        border-radius: 30px;
    }

    .modal-footer {
        justify-content: flex-start;
    }

    .btn {
        border-radius: 15px;
    }
</style>

<div class="container mt-5">
    <h2>Settings</h2>
    <p>Your settings content goes here.</p>

    <!-- Delete Account Button -->
    <div class="d-grid gap-2 mb-3">
        <button type="button" class="btn btn-danger btn-sm custom-btn" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
            DELETE ACCOUNT
        </button>
    </div>

    <!-- Delete Account Modal -->
    <div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteAccountModalLabel">Confirm Delete Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete your account? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <!-- Delete Account Form -->
                    <form asp-controller="User" asp-action="DeleteAccount" method="post">
                        <button type="submit" class="btn btn-danger">Delete Account</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- TOTP Button -->
    <div class="d-grid gap-2">
        <button type="button" class="btn btn-primary custom-btn" data-bs-toggle="modal" data-bs-target="#totpModal">
            ENABLE TOTP
        </button>
    </div>

    <!-- TOTP Modal -->
    <div class="modal fade" id="totpModal" tabindex="-1" aria-labelledby="totpModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="totpModalLabel">TOTP QRCode</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- TOTP QRCode Image -->
                    <img src="data:image/png;base64,@Convert.ToBase64String(Model.OTPQRCode)" alt="TotpQRCode Image" style="max-width: 100%; height: auto;" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <!-- Regenerate QR Code Button -->
                    <button type="button" class="btn btn-success" id="regenerateQRCodeButton">
                        Regenerate QR Code
                    </button>
                    <!-- Save and Enable OTP Button -->
                    <button type="button" class="btn btn-danger" id="saveTOTPButton">Save and Enable OTP</button>
                    <!-- TOTP Form -->
                    <form id="tOTPForm" asp-controller="User" asp-action="SaveQRCodeOTP" method="post">
                        <input type="hidden" name="QRCodeOTPSK" id="tOTPQRCodeInput" value="@Model.OTPQRCodeSK" />
                    </form>
                    
                    <!-- JavaScript to submit the TOTP Form -->
                    <script>
                        var saveTOTPButton = document.getElementById('saveTOTPButton');
                        var tOTPQRCodeInput = document.getElementById('tOTPQRCodeInput');
                        var tOTPForm = document.getElementById('tOTPForm');

                        saveTOTPButton.addEventListener('click', function () {
                            tOTPForm.submit();
                        });
                    </script>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- JavaScript to handle QR code regeneration -->
    <script>
        $(document).ready(function () {
            $('#regenerateQRCodeButton').on('click', function () {
                // Make an AJAX request to regenerate the QR code
                $.ajax({
                    url: '@Url.Action("GenerateOTPQRCode", "Home")',
                    type: 'GET',
                    success: function (data) {
                        // Update the QR code image and the secret key
                        $('#totpModal img').attr('src', 'data:image/png;base64,' + data.oTPQRCode);
                        $('#tOTPQRCodeInput').val(data.oTPQRCodeSK);

                        // Log to console for debugging
                        console.log('QR Code regenerated successfully.');
                    },
                    error: function () {
                        // Handle error if needed
                        console.error('Failed to regenerate QR code.');
                    }
                });
            });
        });
    </script>
}